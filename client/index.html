<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telemetry Client Demo</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>ðŸ”­ Telemetry Client Demo</h1>

      <div class="section">
        <h2>Configuration</h2>
        <div class="config">
          <label for="serverUrl">Server URL (HTTP/JSON):</label>
          <input type="text" id="serverUrl" value="http://localhost:8080" />
          <div style="font-size: 12px; color: #666; margin-top: 5px">
            ðŸ’¡ This demo uses HTTP/JSON with UUID v7 as bytes. The server also
            supports native gRPC on port 50051 for binary protobuf (smaller
            packet size). Packet size is shown after sending.
          </div>

          <label for="username">Username (if auth enabled):</label>
          <input type="text" id="username" value="" />

          <label for="password">Password (if auth enabled):</label>
          <input type="password" id="password" value="" />
        </div>
      </div>

      <div class="section">
        <h2>Send Telemetry Data</h2>
        <button onclick="sendMetrics()">Send Metrics</button>
        <button onclick="sendLogs()">Send Logs</button>
        <button onclick="sendBoth()">Send Both</button>
        <div id="sendStatus"></div>
      </div>

      <div class="section">
        <h2>Local Storage Queue</h2>
        <button onclick="retryFailedPackets()">Retry Failed Packets</button>
        <button onclick="clearQueue()">Clear Queue</button>
        <div class="queue-status" id="queueStatus">Queue: 0 packets</div>
        <div id="queueInfo"></div>
      </div>

      <div class="section">
        <h2>Sample Payloads</h2>
        <button onclick="showMetricsSample()">Show Metrics Sample</button>
        <button onclick="showLogsSample()">Show Logs Sample</button>
        <div id="samplePayload"></div>
      </div>
    </div>

    <script src="telemetry.js"></script>
    <script>
      // Initialize and update queue status on load
      window.addEventListener("load", () => {
        updateQueueStatus();
        // Auto-retry failed packets every 30 seconds
        setInterval(() => {
          const queue = telemetry.getQueuedPackets();
          if (queue.length > 0) {
            retryFailedPackets();
          }
        }, 30000);
      });

      function getConfig() {
        return {
          serverUrl: document.getElementById("serverUrl").value,
          username: document.getElementById("username").value,
          password: document.getElementById("password").value,
        };
      }

      function showStatus(elementId, message, type) {
        const el = document.getElementById(elementId);
        el.innerHTML = `<div class="status ${type}">${message}</div>`;
        setTimeout(() => {
          el.innerHTML = "";
        }, 5000);
      }

      function updateQueueStatus() {
        const queue = telemetry.getQueuedPackets();
        document.getElementById("queueStatus").textContent =
          `Queue: ${queue.length} packet(s)`;
      }

      async function sendMetrics() {
        const config = getConfig();
        try {
          const result = await telemetry.sendMetrics(
            config.serverUrl,
            config.username,
            config.password,
          );
          const sizeMsg = result.packetSize
            ? ` (${result.packetSize} bytes)`
            : "";
          showStatus(
            "sendStatus",
            result.message + sizeMsg,
            result.success ? "success" : "error",
          );
        } catch (error) {
          showStatus("sendStatus", `Error: ${error.message}`, "error");
        }
        updateQueueStatus();
      }

      async function sendLogs() {
        const config = getConfig();
        try {
          const result = await telemetry.sendLogs(
            config.serverUrl,
            config.username,
            config.password,
          );
          const sizeMsg = result.packetSize
            ? ` (${result.packetSize} bytes)`
            : "";
          showStatus(
            "sendStatus",
            result.message + sizeMsg,
            result.success ? "success" : "error",
          );
        } catch (error) {
          showStatus("sendStatus", `Error: ${error.message}`, "error");
        }
        updateQueueStatus();
      }

      async function sendBoth() {
        const config = getConfig();
        try {
          const result = await telemetry.sendBoth(
            config.serverUrl,
            config.username,
            config.password,
          );
          const sizeMsg = result.packetSize
            ? ` (${result.packetSize} bytes)`
            : "";
          showStatus(
            "sendStatus",
            result.message + sizeMsg,
            result.success ? "success" : "error",
          );
        } catch (error) {
          showStatus("sendStatus", `Error: ${error.message}`, "error");
        }
        updateQueueStatus();
      }

      async function retryFailedPackets() {
        const config = getConfig();
        const result = await telemetry.retryQueuedPackets(
          config.serverUrl,
          config.username,
          config.password,
        );
        showStatus(
          "queueInfo",
          result.message,
          result.success ? "success" : "info",
        );
        updateQueueStatus();
      }

      function clearQueue() {
        telemetry.clearQueue();
        showStatus("queueInfo", "Queue cleared!", "success");
        updateQueueStatus();
      }

      function showMetricsSample() {
        const sample = telemetry.generateMetricsPayload();
        const payload = {
          schema_version: 1,
          metadata: telemetry.generateMetadata(),
          metrics: sample,
        };
        document.getElementById("samplePayload").innerHTML =
          "<pre>" + JSON.stringify(payload, null, 2) + "</pre>";
      }

      function showLogsSample() {
        const sample = telemetry.generateLogsPayload();
        const payload = {
          schema_version: 1,
          metadata: telemetry.generateMetadata(),
          logs: sample,
        };
        document.getElementById("samplePayload").innerHTML =
          "<pre>" + JSON.stringify(payload, null, 2) + "</pre>";
      }
    </script>
  </body>
</html>
